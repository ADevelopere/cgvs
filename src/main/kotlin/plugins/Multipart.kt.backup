package plugins

import io.ktor.server.application.*
import io.ktor.server.plugins.requestvalidation.*

fun Application.configureMultipart() {
    // Configure multipart handling
    // Note: Ktor handles multipart out of the box, but we can add validation
    
    install(RequestValidation) {
        // Add validation for file uploads if needed
        validate<String> { value ->
            // Example validation - you can customize this
            if (value.length > 1000000) { // 1MB limit for string fields
                ValidationResult.Invalid("Field too large")
            } else {
                ValidationResult.Valid
            }
        }
    }
    
    // Log multipart configuration on startup
    monitor.subscribe(ApplicationStarted) { application ->
        application.log.info("Multipart configuration initialized")
        val uploadLimit = application.environment.config.propertyOrNull("filesystem.upload_limit")?.getString() ?: "not set"
        application.log.info("Upload limit from config: $uploadLimit")
    }
}
